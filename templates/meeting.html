{% extends 'base.html' %}

{% block content %}

<style>
    #chatBox {
        border: 1px solid #ccc;
        height: 300px;
        overflow-y: scroll;
        padding: 10px;
        background: #f8f8f8;
    }

    .message {
        max-width: 70%;
        margin: 5px 0;
        padding: 10px;
        border-radius: 10px;
        clear: both;
        word-break: break-word;
    }

    .my-message {
        background-color: #dcf8c6;
        float: right;
        text-align: right;
    }

    .other-message {
        background-color: #ffffff;
        float: left;
        text-align: left;
    }

    .container {
        display: flex;
        gap: 30px;
        margin-top: 20px;
    }

    .chat-section {
        flex: 3;
        display: flex;
        flex-direction: column;
    }

    .chat-input-row {
        display: flex;
        margin-top: 10px;
    }

    .chat-input-row input[type="text"] {
        flex: 1;
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 4px 0 0 4px;
        outline: none;
    }

    .chat-input-row button {
        padding: 8px 16px;
        border: 1px solid #ccc;
        border-left: none;
        border-radius: 0 4px 4px 0;
        background: #4caf50;
        color: white;
        cursor: pointer;
    }

    .members-section {
        flex: 1;
        background: #f4f4f4;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 15px;
        min-width: 150px;
        max-width: 220px;
        height: fit-content;
    }
</style>
<style>
    #participant-list, #blocked-list {
    max-height: 200px;
    overflow-y: auto;
    padding: 10px;
    border: 1px solid #eee;
    border-radius: 5px;
    background: #fafafa;
}

#participant-list li, #blocked-list li {
    padding: 5px;
    border-bottom: 1px solid #eee;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

button {
    background: #ff6b6b;
    color: white;
    border: none;
    padding: 3px 8px;
    border-radius: 3px;
    cursor: pointer;
}
.user-action-form button {
    background: #ff6b6b;
    color: white;
    border: none;
    padding: 3px 8px;
    border-radius: 3px;
    cursor: pointer;
    margin-left: 10px;
}
</style>


<h1>Meeting Room</h1>

<p><strong>Meeting ID:</strong> {{ meetingId }}</p>
<p><strong>Host:</strong> {{ host }}</p>

{% if host == session['username'] %}
<p><strong>Passkey:</strong> {{ passkey }}</p>

{% if meeting_name %}
    <h2>ðŸ“Œ {{ meeting_name }}</h2>
{% else %}
    <h2>ðŸ“Œ No Meeting Title Yet</h2>
{% endif %}


{% if not meeting_name %}
<form method = 'POST'>
    <label for="meeting_name">Edit Meeting Name:</label>

    <input type="text" id="meeting_name" name="meeting_name" value="{{ meeting_name or '' }}" required>

    <button type="submit">Save</button>
</form>
{% endif %}

{% endif %}

<hr>

<div class="container">
    <div class="chat-section">
        <h3>Live Chat</h3>
        <div id="chatBox">
            {% for sender, message, timestamp in chat_history %}
                <div class="message {% if sender == session['username'] %}my-message{% else %}other-message{% endif %}">
                    <strong>{{ sender }}:</strong> {{ message }}<br>
                    <small style="font-size: 10px; color: gray;">{{ timestamp }}</small>
                </div>
            {% endfor %}
        </div>

        <div class="chat-input-row">
            <input type="text" id="msgInput" placeholder="Type a message">
            <button onclick="sendMessage()">Send</button>
        </div>
    </div>
    <div class="members-section">
    <h4>Members</h4>
    <div>
        <h3>Active Participants</h3>
        <ul id="participant-list">
            {% for user in active_users %}
            <li data-username="{{ user }}">
                {{ user }}
                {% if host == session['username'] and user != session['username'] %}
                <form class="user-action-form" method="POST" action="/update_user_status">
                    <input type="hidden" name="user_id" value="{{ user }}">
                    <input type="hidden" name="meeting_id" value="{{ meetingId }}">
                    <input type="hidden" name="action" value="block">
                    <button type="submit">Block</button>
                </form>
                {% endif %}
            </li>
            {% endfor %}
        </ul>

        <h3>Blocked Users</h3>
        <ul id="blocked-list">
            {% for user in blocked_users %}
            <li data-username="{{ user }}">
                {{ user }}
                {% if host == session['username'] %}
                <form class="user-action-form" method="POST" action="/update_user_status">
                    <input type="hidden" name="user_id" value="{{ user }}">
                    <input type="hidden" name="meeting_id" value="{{ meetingId }}">
                    <input type="hidden" name="action" value="unblock">
                    <button type="submit">Unblock</button>
                </form>
                {% endif %}
            </li>
            {% endfor %}
        </ul>
    </div>
</div>
</div>
</div>


<script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
<script>

    const socket = io();
    const meetingId = "{{ meetingId }}";
    const currentUser = "{{ session['username'] }}";
    const meetingHost = "{{ host }}";
    socket.on("connect", () => {
        socket.emit("join", { meetingId });
    });

    socket.on("status", (data) => {
        const box = document.getElementById("chatBox");
        const p = document.createElement("p");
        p.style.fontStyle = "italic";
        p.textContent = data.msg;
        box.appendChild(p);
        box.scrollTop = box.scrollHeight;
    });
    socket.on('redirect', function(data) {
    window.location.href = data.url;
});
    socket.on("receive_message", (data) => {
        const box = document.getElementById("chatBox");
        const msgDiv = document.createElement("div");
        const username = "{{ session['username'] }}";
        
        const [sender, ...rest] = data.msg.split(':');
        const messageText = rest.join(':').trim();

        msgDiv.classList.add("message");
        if (sender.trim() === username.trim()) {
            msgDiv.classList.add("my-message");
        } else {
            msgDiv.classList.add("other-message");
        }

        msgDiv.innerHTML = `<strong>${sender}:</strong> ${messageText}`;
        box.appendChild(msgDiv);
        box.scrollTop = box.scrollHeight;
    });
    socket.on('private_message', function(data) {
    const box = document.getElementById("chatBox");
    const msgDiv = document.createElement("div");
    msgDiv.classList.add("message");
    msgDiv.style.color = "red";
    msgDiv.textContent = data.msg;
    box.appendChild(msgDiv);
    box.scrollTop = box.scrollHeight;
});
socket.on('user_unblocked', (data) => {
    const box = document.getElementById("chatBox");
    const p = document.createElement("p");
    p.style.fontStyle = "italic";
    p.style.color = "green";
    p.textContent = `${data.user_id} has been unblocked.`;
    box.appendChild(p);
    box.scrollTop = box.scrollHeight;
});
    function sendMessage() {
        const msgInput = document.getElementById("msgInput");
        const msg = msgInput.value.trim();
        if (msg !== "") {
            socket.emit("send_message", { meetingId, msg });
            msgInput.value = "";
        }
    }
    socket.on('user_blocked', (data) => {
    if (data.user_id === currentUser && data.meeting_id === meetingId) {
        window.location.href = "/access_denied";
    }
});
</script>
<script>

   function updateUserLists() {
    fetch(`/meeting/${meetingId}/users`)
        .then(response => response.json())
        .then(data => {
            const activeList = document.getElementById("participant-list");
            const blockedList = document.getElementById("blocked-list");
            
            // Clear the lists
            activeList.innerHTML = '';
            blockedList.innerHTML = '';
            
            data.users.forEach(user => {
                const li = document.createElement("li");
                li.dataset.username = user.username;
                li.textContent = user.username;
                
                if (!user.isBlocked) {
                    // Only show block button for others and if host
                    if (currentUser === meetingHost && user.username !== currentUser) {
                        const form = createForm(user.username, "block");
                        li.appendChild(form);
                    }
                    activeList.appendChild(li);
                } else {
                    if (currentUser === meetingHost) {
                        const form = createForm(user.username, "unblock");
                        li.appendChild(form);
                    }
                    blockedList.appendChild(li);
                }
            });
        });
}

    function createForm(username, action) {
    const form = document.createElement("form");
    form.className = "user-action-form";
    // Remove method and action attributes
    form.innerHTML = `
        <input type="hidden" name="user_id" value="${username}">
        <input type="hidden" name="meeting_id" value="${meetingId}">
        <input type="hidden" name="action" value="${action}">
        <button type="submit">${action === 'block' ? 'Block' : 'Unblock'}</button>
    `;
    return form;
}
        function checkBlockStatus() {
        fetch(`/meeting/${meetingId}/check_status`)
            .then(response => response.json())
            .then(data => {
                if (data.status === "blocked") {
                    window.location.href = "/access_denied";
                }
            });
    }
    // Add this event listener to prevent default form submission
// Fix form submission handler
document.addEventListener('submit', function(e) {
    if (e.target.classList.contains('user-action-form')) {
        e.preventDefault();
        const form = e.target;
        const button = form.querySelector('button');
        const actionInput = form.querySelector('input[name="action"]');
        const action = actionInput ? actionInput.value : '';
        
        button.disabled = true;
        button.textContent = 'Processing...';
        
        const formData = new FormData(form);
        
        fetch(form.action, {
            method: 'POST',
            body: formData
        })
        .then(response => {
            if (response.ok) {
                // Update UI immediately after successful action
                updateUserLists();
            }
        })
        .catch(error => console.error('Error:', error))
        .finally(() => {
            button.disabled = false;
            button.textContent = action === 'block' ? 'Block' : 'Unblock';
        });
    }
});
    

    // Run immediately and every 5 seconds
    checkBlockStatus();
    setInterval(checkBlockStatus, 5000);

    
    document.addEventListener('DOMContentLoaded', () => {
    checkBlockStatus(); // Immediate check
    setInterval(checkBlockStatus, 5000); // Periodic checks
    
    updateUserLists(); // Initial user list
    setInterval(updateUserLists, 5000); // Periodic updates
});
</script>


{% endblock %}
